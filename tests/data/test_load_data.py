import os
from contextlib import AbstractContextManager
from contextlib import nullcontext as does_not_raise
from typing import Optional

import pytest
from datasets import DatasetDict


from src.data.load_data import load_data
from src import DatasetType, NumCausalType, SentenceType, TaskType

THIS_DIR: str = os.path.dirname(os.path.abspath(__file__))


@pytest.mark.parametrize(
    "task_name, dataset_name, test_samples, sent_type, num_causal, num_train, num_valid, num_test, expectation",
    [
        (
            "sequence_classification",
            "altlex",
            None,
            "all",
            "all",
            462,
            115,
            401,
            does_not_raise(),
        ),
        (
            "sequence_classification",
            "altlex",
            None,
            "intra",
            "all",
            -1,
            -1,
            -1,
            pytest.raises(ValueError),
        ),
        ("span_detection", "altlex", 300, "all", "all", 240, 60, 115, does_not_raise()),
        (
            "span_detection",
            "altlex",
            None,
            "all",
            "single",
            229,
            57,
            103,
            does_not_raise(),
        ),
        (
            "sequence_classification",
            "because",
            None,
            "all",
            "all",
            852,
            51,
            51,
            does_not_raise(),
        ),
        (
            "sequence_classification",
            "because",
            None,
            "inter",
            "all",
            -1,
            -1,
            -1,
            pytest.raises(ValueError),
        ),
        (
            "span_detection",
            "because",
            None,
            "all",
            "all",
            679,
            41,
            41,
            does_not_raise(),
        ),
        (
            "span_detection",
            "because",
            None,
            "all",
            "single",
            521,
            36,
            36,
            does_not_raise(),
        ),
        (
            "span_detection",
            "because",
            None,
            "all",
            "multi",
            158,
            5,
            5,
            does_not_raise(),
        ),
        (
            "sequence_classification",
            "ctb",
            None,
            "all",
            "all",
            1569,
            316,
            316,
            does_not_raise(),
        ),
        (
            "sequence_classification",
            "ctb",
            None,
            "intra",
            "all",
            1117,
            212,
            212,
            does_not_raise(),
        ),
        (
            "sequence_classification",
            "ctb",
            None,
            "inter",
            "all",
            452,
            104,
            104,
            does_not_raise(),
        ),
        (
            "span_detection",
            "ctb",
            None,
            "all",
            "single",
            -1,
            -1,
            -1,
            pytest.raises(ValueError),
        ),
        (
            "sequence_classification",
            "esl",
            None,
            "all",
            "all",
            1768,
            232,
            232,
            does_not_raise(),
        ),
        (
            "sequence_classification",
            "esl",
            None,
            "intra",
            "all",
            776,
            97,
            97,
            does_not_raise(),
        ),
        (
            "sequence_classification",
            "esl",
            None,
            "inter",
            "all",
            992,
            135,
            135,
            does_not_raise(),
        ),
        (
            "sequence_classification",
            "pdtb",
            None,
            "all",
            "all",
            26684,
            8083,
            8083,
            does_not_raise(),
        ),
        (
            "sequence_classification",
            "pdtb",
            1000,
            "all",
            "all",
            26684,
            8083,
            1000,
            does_not_raise(),
        ),
        (
            "sequence_classification",
            "pdtb",
            None,
            "intra",
            "all",
            10865,
            3397,
            3397,
            does_not_raise(),
        ),
        (
            "sequence_classification",
            "pdtb",
            None,
            "inter",
            "all",
            15819,
            4686,
            4686,
            does_not_raise(),
        ),
        (
            "span_detection",
            "pdtb",
            None,
            "all",
            "all",
            6912,
            2076,
            2076,
            does_not_raise(),
        ),
        (
            "span_detection",
            "pdtb",
            None,
            "all",
            "single",
            6331,
            1857,
            1857,
            does_not_raise(),
        ),
        (
            "span_detection",
            "pdtb",
            None,
            "all",
            "multi",
            640,
            160,
            219,
            does_not_raise(),
        ),
        (
            "sequence_classification",
            "semeval",
            None,
            "all",
            "all",
            6380,
            1595,
            2715,
            does_not_raise(),
        ),
        (
            "sequence_classification",
            "semeval",
            None,
            "intra",
            "all",
            -1,
            -1,
            -1,
            pytest.raises(ValueError),
        ),
        (
            "sequence_classification",
            "fincausal",
            None,
            "all",
            "all",
            17060,
            2132,
            2133,
            does_not_raise(),
        ),
        (
            "sequence_classification",
            "fincausal",
            None,
            "intra",
            "all",
            9680,
            1210,
            1211,
            does_not_raise(),
        ),
        (
            "sequence_classification",
            "fincausal",
            None,
            "inter",
            "all",
            7379,
            922,
            923,
            does_not_raise(),
        ),
        (
            "span_detection",
            "fincausal",
            None,
            "all",
            "all",
            1087,
            136,
            136,
            does_not_raise(),
        ),
        (
            "chain_classification",
            "reco",
            None,
            "all",
            "all",
            3111,
            417,
            672,
            does_not_raise(),
        ),
        (
            "chain_classification",
            "pdtb",
            None,
            "all",
            "all",
            -1,
            -1,
            -1,
            pytest.raises(ValueError),
        ),
    ],
)
def test_load_data(
    task_name: str,
    dataset_name: str,
    test_samples: Optional[int],
    sent_type: str,
    num_causal: str,
    num_train: int,
    num_valid: int,
    num_test: int,
    expectation: AbstractContextManager,
) -> None:
    with expectation:
        dsd: DatasetDict = load_data(
            task_enum=TaskType[task_name],
            dataset_enum=DatasetType[dataset_name],
            sentencetype_enum=SentenceType[sent_type],
            numcausal_enum=NumCausalType[num_causal],
            data_dir=os.path.join(THIS_DIR, "../../data"),
            test_samples=test_samples,
        )
        assert isinstance(dsd, DatasetDict)
        assert len(dsd["train"]) == num_train
        assert len(dsd["valid"]) == num_valid
        assert len(dsd["test"]) == num_test
